#ifndef SDIF_BOOLEANtypedef unsigned char Boolean;#undef TRUE#define TRUE 1#undef FALSE#define FALSE 0#define SDIF_BOOLEAN#endif#include <stdio.h>#include <stdarg.h>#include <float.h>#include "sdif.h"#include "sdif-mem.h"#include "sdif-buf.h"#include "sdif-interp.h"#include "sdif-util.h"#include "sdif-unit.h"#include "sdif-unit-utils.h"//  prototype for entrypointUnitTestFn unit_buf;//  prototypes for local functionsstatic SDIFresult doTest(void);void *unit_buf(SDIFunitCmd cmd, ...){  void *result = NULL;    va_list va;  va_start(va, cmd);  switch(cmd)  {    case ESDIF_UNIT_CMD_NAME:      result = "buffer operations test";      break;    case ESDIF_UNIT_CMD_RUN:      result = (void *)doTest();      break;  }    va_end(va);    return result;}//  test various SDIFbuf_Buffer operationsstatic SDIFresult doTest(void){  #define VERY_SMALL ((sdif_float64) -(DBL_MAX))  sdif_float32 list1[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12};  sdif_float64 list2[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12};  sdif_float64 t;  SDIFmem_Matrix m1, m11, m2, m3, m4;  SDIFmem_Frame f1, f11, f2, f3, f4, f;  SDIFbuf_Buffer b1, b2;    int i;  SDIFresult r;  //  create matrices  m1 = SDIFutil_CreateMatrix(2, 6, SDIF_FLOAT32, "----");  m11 = SDIFutil_CreateMatrix(2, 6, SDIF_FLOAT32, "----");  m2 = SDIFutil_CreateMatrix(2, 6, SDIF_FLOAT32, "----");  m3 = SDIFutil_CreateMatrix(2, 6, SDIF_FLOAT64, "----");  m4 = SDIFutil_CreateMatrix(2, 6, SDIF_FLOAT64, "----");  unit_assert((m1 && m11 && m2 && m3 && m4), "matrix creation failed\n");  //  load matrices with different data types  SDIFutil_LoadMatrixFloat32(m1, list1);  SDIFutil_LoadMatrixFloat32(m11, list1);  SDIFutil_LoadMatrixFloat64(m2, list2);  SDIFutil_LoadMatrixFloat32(m3, list1);  SDIFutil_LoadMatrixFloat64(m4, list2);    //  create frames  f1 = SDIFmem_CreateEmptyFrame();  f11 = SDIFmem_CreateEmptyFrame();  f2 = SDIFmem_CreateEmptyFrame();  f3 = SDIFmem_CreateEmptyFrame();  f4 = SDIFmem_CreateEmptyFrame();  unit_assert((f1 && f11 && f2 && f3 && f4), "frame creation failed\n");  SDIF_Copy4Bytes(f1->header.frameType, "----");  f1->header.time = 1;  f1->header.streamID = 1;  r = SDIFmem_AddMatrix(f1, m1);  SDIF_Copy4Bytes(f11->header.frameType, "----");  f11->header.time = 1;  f11->header.streamID = 1;  r |= SDIFmem_AddMatrix(f11, m11);  SDIF_Copy4Bytes(f2->header.frameType, "----");  f2->header.time = 2;  f2->header.streamID = 1;  r |= SDIFmem_AddMatrix(f2, m2);  SDIF_Copy4Bytes(f3->header.frameType, "----");  f3->header.time = 3;  f3->header.streamID = 1;  r |= SDIFmem_AddMatrix(f3, m3);  SDIF_Copy4Bytes(f4->header.frameType, "----");  f4->header.time = 4;  f4->header.streamID = 1;  r |= SDIFmem_AddMatrix(f4, m4);    unit_assert(r == ESDIF_SUCCESS, "adding matrices to frames failed\n");    //  test buffer creation  b1 = SDIFbuf_Create();  b2 = SDIFbuf_Create();  unit_assert((b1 && b2), "buffer creation failed\n");    //  add one frame to buffer    //  check replace / don't replace behavior  r = SDIFbuf_InsertFrame(b1, f1, ESDIF_INSERT_DONT_REPLACE);  unit_assert(r == ESDIF_SUCCESS, "buf test 1 failed (%d)\n", r);  r = SDIFbuf_InsertFrame(b1, f1, ESDIF_INSERT_DONT_REPLACE);  unit_assert(r == ESDIF_FRAME_ALREADY_EXISTS, "buf test 2 failed (%d)\n", r);  //  NOTE: replacing a frame with itself is a special case (does nothing)  r = SDIFbuf_InsertFrame(b1, f1, ESDIF_INSERT_REPLACE);  unit_assert(r == ESDIF_SUCCESS, "buf test 3 failed (%d)\n", r);  r = SDIFbuf_InsertFrame(b1, f11, ESDIF_INSERT_REPLACE);  unit_assert(r == ESDIF_SUCCESS, "buf test 3a failed (%d)\n", r);  //  insert more frames    r = SDIFbuf_InsertFrame(b1, f2, ESDIF_INSERT_DONT_REPLACE);  r |= SDIFbuf_InsertFrame(b2, f3, ESDIF_INSERT_DONT_REPLACE);  r |= SDIFbuf_InsertFrame(b2, f4, ESDIF_INSERT_DONT_REPLACE);  unit_assert(r == ESDIF_SUCCESS, "buf test 4 failed (%d)\n", r);  //  check min/max time tracking  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMinTime(b1, &t), "buf test 5 failed\n");  unit_assert(t == 1, "buf test 6 failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMaxTime(b1, &t), "buf test 7 failed\n");  unit_assert(t == 2, "buf test 8 failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMinTime(b2, &t), "buf test 9 failed\n");  unit_assert(t == 3, "buf test 10 failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMaxTime(b2, &t), "buf test 11 failed\n");  unit_assert(t == 4, "buf test 12 failed\n");    //  check frame count (start search from time == negative infinity)  for(f = SDIFbuf_GetFrame(b1, (sdif_float64)VERY_SMALL, ESDIF_SEARCH_FORWARDS), i = 0;      f;      f = f->next, i++)    ;  unit_assert(i == 2, "buf test 13 failed\n");  for(f = SDIFbuf_GetFrame(b2, (sdif_float64)VERY_SMALL, ESDIF_SEARCH_FORWARDS), i = 0;      f;      f = f->next, i++)    ;  unit_assert(i == 2, "buf test 14 failed\n");    //  test time shift to zero  unit_assert(ESDIF_SUCCESS == SDIFbuf_TimeShiftToZero(b1), "buf test 14a failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMinTime(b1, &t), "buf test 14b failed\n");  unit_assert(t == 0, "buf test 14c failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMaxTime(b1, &t), "buf test 14d failed\n");  unit_assert(t == 1, "buf test 14e failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_TimeShiftToZero(b2), "buf test 15a failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_TimeShiftToZero(b2), "buf test 15b failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMinTime(b2, &t), "buf test 15c failed\n");  unit_assert(t == 0, "buf test 15d failed\n");  unit_assert(ESDIF_SUCCESS == SDIFbuf_GetMaxTime(b2, &t), "buf test 15e failed\n");  unit_assert(t == 1, "buf test 15f failed\n");      //  free buffers (also frees all frames + matrices in buffers)  SDIFbuf_Free(b1);  SDIFbuf_Free(b2);    return ESDIF_SUCCESS;}