#include <stdio.h>#include <stdlib.h>#include <stdarg.h>#include "sdif.h"#include "sdif-mem.h"#include "sdif-buf.h"#include "sdif-interp.h"#include "sdif-unit.h"//  list of all known unit tests//  (***add new unit tests here***)UnitTestFn unit_basic;UnitTestFn unit_buf;UnitTestFn unit_randomLinear1;UnitTestFn unit_randomLinear2;UnitTestFn unit_randomNaNLinear;UnitTestFn unit_randomNaNLagrange;UnitTestFn unit_randomNaNNeighbors;UnitTestFn *allTests[] = {unit_basic,                           unit_buf,                           unit_randomLinear1,                           unit_randomLinear2,                           unit_randomNaNLinear,                          unit_randomNaNLagrange,                          unit_randomNaNNeighbors,                          NULL                          };//static int log_level = LOG_ALL;       //  0 = show all mesgs//static int log_level = LOG_INFO2;//static int log_level = LOG_INFO;static int log_level = LOG_RESULTS;//static int log_level = LOG_ASSERT;//static int log_level = LOG_PROMPT;    //  show only menus + promptsstatic int assert_count; static int menu(void);static SDIFresult init(void);static void *my_getbytes(int numBytes);static void my_freebytes(void *bytes, int size);int main(void){  SDIFresult r;  int i;    if(ESDIF_SUCCESS != (r = init()))  {    unit_log(LOG_PROMPT, "couldn't init sdif library (%d)\n", r);    goto bail;  }  	while(0 != (i = menu()))	  if(i > 0)	  {	    unit_assert_SetCount(0);	    r = (SDIFresult)(*allTests[i - 1])(ESDIF_UNIT_CMD_RUN);	    if((r == ESDIF_SUCCESS) && (unit_assert_GetCount() == 0))	      unit_log(LOG_PROMPT, "test %d passed\n\n", i);	    else	      unit_log(LOG_PROMPT, "***test %d failed (%d)***\n\n", i, r);	  }	bail:	unit_log(LOG_PROMPT, "goodbye!\n");	return 0;}static int menu(void){  int i;  int result;  int max;	unit_log(LOG_PROMPT, "unit test console for SDIF libs:\n");  for(i = 0; allTests[i]; i++)    unit_log(LOG_PROMPT, "%d) %s\n", i + 1, (*allTests[i])(ESDIF_UNIT_CMD_NAME));	  unit_log(LOG_PROMPT, "0) quit\n");  max = i + 1;    scanf("%d", &result);    if(result >= max)  {    unit_log(10, "choice %d not available\n", result);    result = -1;  }  return result;}static SDIFresult init(void){  SDIFresult r;  	if(ESDIF_SUCCESS != (r = SDIF_Init())) 	  return r;		if(ESDIF_SUCCESS != (r = SDIFmem_Init(my_getbytes, my_freebytes)))		return r;  	if(ESDIF_SUCCESS != (r = SDIFbuf_Init())) 	  return r;		if(ESDIF_SUCCESS != (r = SDIFinterp_Init())) 	  return r;	  return ESDIF_SUCCESS;}static void *my_getbytes(int numBytes) {	return (void *)malloc(numBytes);}static void my_freebytes(void *bytes, int size) {	free(bytes);}void unit_log(SDIFunitLogLevel level, char *fmt, ...){  va_list va;    va_start(va, fmt);    //  selectively suppress log messages (log_level = 0 shows all mesgs)  if(level >= log_level)    vprintf(fmt, va);    va_end(va);}void unit_assert(Boolean test, char *fmt, ...){  va_list va;    va_start(va, fmt);    if(!test)  {    ++assert_count;        //  selectively suppress log messages (log_level = 0 shows all mesgs)    if(LOG_ASSERT >= log_level)      vprintf(fmt, va);  }    va_end(va);}int unit_assert_GetCount(){  return assert_count;}void unit_assert_SetCount(int count){  assert_count = count;}